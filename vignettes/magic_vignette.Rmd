---
title: "Simulating a 16-way MAGIC population with magicsim"
output: rmarkdown::html_vignette
author: "Sarah Odell"
date: "2/27/2019"
vignette: >
  %\VignetteIndexEntry{"Simulating a 16-way MAGIC population with magicsim"}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Simulating a 16-way MAGIC population with magic sim

The following uses magicsim to simulate 400 double haploid maize lines that were derived from a 16-way Multi-parent Advanced Generation InterCross (MAGIC) funnel crossing scheme.

| A x B | C x D | E x F | G x H | I x J | K x L | M x N | O x P |
|       | AB x CD | EF x GH | IJ x KL | MN  x OP |      |       |
|       |         | ABCD x EFGH | IJKL x MNOP |   |    |   |    |
|       |         |  ABCDEFGH x IJKLMNOP |    |   |    |   |    |
                        
A population of 2000 MAGIC lines are created, followed by 3 generations of outcrossing (synthetic). Then 400 of these MAGIC S3 lines are made into double haploids (entirely homozygous).                 
### Installation
```{r }
### Script to simulate 400 Double Haploid MAGIC lines

devtools::install_github('sarahodell/magicsim',force = T)

library('magicsim')
library("data.table")
library("tidyverse")

options(scipen=999)
```

### Initializing Founder lines

magicsim simulates recombination evens using a genetic map of the organism. In this case, we are using a genetic map of maize generated by Ogut et al. (2015).

The cross order specifies which founder lines where crossed in the first stage of the funnel scheme. (i.e. here EP1 and A632 were crossed first, as were OH43 and B73).

We will do this for maize chromosome 10 only, although this can be done for any number of chromosomes.
```{r}

gmap=fread('ogutmap_v4_ordered.csv',data.table=F)

# The 16 founder maize inbred lines. This could be anything
founders=c("A632","B73","CO255_inra","FV252",
           "OH43","A654","FV2","C103",
           "EP1","D105","W117","B96","DK63",
           "F492","ND245","VA85")

cross_order=c(2,4,14,15,3,8,10,16,1,9,5,6,12,7,11,13)
cross_info=founders[cross_order]


### Simulate chromosome 10
c=10
### Initialize founder chromosomes for the 16 founders
founder_list=list()
for(p in seq(1,length(cross_info))){
  founder_list[[p]]=list()
  founder_list[[p]][[c]]=chrom_init(c,gmap,h1_donor=cross_info[p],h2_donor=cross_info[p])
}
```

### Create the first round of F1s

Using the crossing order above and the simulated founder chromosomes, we can create F1s from the first round of crossing of the MAGIC crossing scheme.

```{r}
### Create F1s from the first round of crossing
f1s=list()
count=1
for(i in seq(1,length(founder_list),2)){
  f1=list()
  for(x in seq(1,10)){f1[[x]]=make_f1(founder_list[[i]][[x]],founder_list[[i+1]][[x]],gmap,x)}
  f1s[[count]]=f1
  count=count+1
}

```

### Building a MAGIC Population.
Create synthetic population of 2000 lines from MAGIC founder funnel
```{r}
magic_pop=list()
for(x in seq(1,2000)){magic_pop[[x]]=make_magic(f1s,10,gmap)}
```

### Simulate Outcrossing

Random outcrossing within the synthetic population for 3 generations

```{r}
synth_pop=outcross(magic_pop,3,10,gmap)
```

### Get Doubled Haploids

Randomly select 400 lines from the synthetic population and
then choose one of the chromosomes at random to duplicate

```{r}

#randomly choose 400 out of the 2000
draw=sample(seq(1,2000),400,replace=F)

dh_pop=list()
for(d in seq(1,400)){
  line=draw[d]
  # randomly choose one of the two chromosomes
  if(runif(1)>0.5){
    dh_pop[[d]]=list(chr=10,h1=synth_pop[[line]][[10]]$h1,h2=synth_pop[[line]][[10]]$h1)
  }
  else{
    dh_pop[[d]]=list(chr=10,h1=synth_pop[[line]][[10]]$h2,h2=synth_pop[[line]][[10]]$h2)
  }
}

# Can be saved as an R object
#saveRDS(dh_pop,'MAGIC_DHSim.rds')

```

### Assessing the simulated lines

Looking at number of crossovers
```{r}
no=sapply(seq(1,400),function(x) length(dh_pop[[x]]$h1$donors))
#add the crossover count as xo_no to dh_pop
for(i in seq(1,400)){dh_pop[[i]]$xo_no=count_breakpoints(dh_pop[[i]],hom=T)}
#what is the distribution of xo_no in the population?
total_xo=c()
for(i in seq(1,400)){total_xo=c(total_xo,dh_pop[[i]]$xo_no)}

crossovers=data.frame(ind=seq(1,400),xo_no=total_xo)
ggplot(crossovers,aes(x=total_xo)) + geom_histogram(bins=9,fill="darkgreen",color="black") + theme_classic() +
  ggtitle("Distribution of Crossovers in Simulation DH Population") + xlab("Crossover Number") + 
  ylab("Frequency")

```


Convert the dh_pop object into breakpoints dataframe
```{r}
#This should be its own function
breaktable=make_breaktable(dh_pop)
head(breaktable)
```

### Visualization

Plotting some of the lines can be useful in seeing how representative the simulated lines are.

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
